<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Invoice Processor</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="dashboard.js"></script>
    <script src="scripts/utils.js"></script>
    <script src="record.js"></script>
    <script src="vendor-master.js"></script>
    <script src="user.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <i class="fas fa-file-invoice"></i>
                <span>ArkDocs</span>
            </div>
            <nav>
                <ul>
                    <li class="active"><a href="#dashboard-section"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li class="dropdown">
                        <a href="#"><i class="fas fa-upload"></i> Process Invoice <i class="fas fa-caret-down"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="#invoice-section" class="process-option" data-type="Invoice">Invoice</a></li>
                            <li><a href="#po-section" class="process-option" data-type="PO">PO</a></li>
                        </ul>
                    </li>
                    <li><a href="#invoices-section"><i class="fas fa-list"></i> Invoice Records</a></li>
                    <li><a href="#user-management-section"><i class="fas fa-user-shield"></i> User Management</a></li>
                    <li><a href="#vendor-master-section"><i class="fas fa-users"></i> Vendor Master</a></li>
                    <li><a href="#settings-section"><i class="fas fa-cog"></i> Settings</a></li>
                </ul>
            </nav>
            <div class="user-profile">
                <div class="avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <span class="username">Loading...</span>
                    <span class="role">Loading...</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <header>
                <div class="header-title">
                    <h1 id="page-title">Invoice Processor</h1>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" id="new-invoice-btn">
                        <i class="fas fa-plus"></i> New Invoice
                    </button>
                </div>
            </header>

            <div class="content-wrapper">
                <!-- Invoice Section -->
                <section id="invoice-section" class="content-section">
                    <div class="section-header">
                        <h2><i class="fas fa-file-invoice"></i> Process Invoice</h2>
                        <p>Upload an invoice PDF to extract and process data</p>
                    </div>

                    <div class="upload-area" id="drop-zone">
                        <div class="upload-content">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h3>Upload Invoice PDF</h3>
                            <p>Drag & drop your invoice file here or click to browse</p>
                            <input type="file" id="pdf-upload" accept="application/pdf" style="display: none;">
                            <button class="btn btn-outline" id="browse-btn">Select File</button>
                        </div>
                        <div id="upload-status" class="status-message"></div>
                    </div>

                    <div id="document-info" class="document-info">
                        <strong>Current Document:</strong> <span id="current-filename">None</span>
                    </div>

                    <!-- File Attachments Section -->
                    <div class="form-group">
                        <label class="form-label">File Attachments *</label>
                        <div id="file-attachments-container">
                            <input type="file" id="file-attachments" multiple accept="application/pdf, image/jpeg, image/png" style="display: none;">
                            <button class="btn btn-outline" id="add-attachment-btn">
                                <i class="fas fa-paperclip"></i> Add Attachment
                            </button>
                            <div id="attachments-list"></div>
                        </div>
                        <p class="info-text">Add supporting documents (PDF, JPG, PNG). At least one attachment is required.</p>
                    </div>

                    <div class="processing-container">
                        <div class="document-viewer-container">
                            <div class="tab-container">
                                <div class="tab active" data-tab="viewer">Document Viewer</div>
                                <div class="tab" data-tab="select">Text Selection</div>
                                <div class="tab" data-tab="extracted">Extracted Text</div>
                                <div class="tab" data-tab="fields">Detected Fields</div>
                            </div>

                            <div class="tab-content active" id="viewer-tab">
                                <div id="pdf-container">
                                    <div class="zoom-controls">
                                        <button class="zoom-btn" id="zoom-in"><i class="fas fa-search-plus"></i></button>
                                        <button class="zoom-btn" id="zoom-out"><i class="fas fa-search-minus"></i></button>
                                        <span id="zoom-level">100%</span>
                                    </div>
                                    <div id="pdf-viewer"></div>
                                </div>
                                <div class="page-controls">
                                    <button class="page-btn" id="prev-page"><i class="fas fa-chevron-left"></i> Previous</button>
                                    <span id="page-info">Page 1 of 1</span>
                                    <button class="page-btn" id="next-page">Next <i class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>

                            <div class="tab-content" id="select-tab">
                                <div id="pdf-select-container">
                                    <div class="zoom-controls">
                                        <button class="zoom-btn" id="select-zoom-in"><i class="fas fa-search-plus"></i></button>
                                        <button class="zoom-btn" id="select-zoom-out"><i class="fas fa-search-minus"></i></button>
                                        <span id="select-zoom-level">100%</span>
                                    </div>
                                    <div id="pdf-select-viewer"></div>
                                </div>
                                <div class="page-controls">
                                    <button class="page-btn" id="select-prev-page"><i class="fas fa-chevron-left"></i> Previous</button>
                                    <span id="select-page-info">Page 1 of 1</span>
                                    <button class="page-btn" id="select-next-page">Next <i class="fas fa-chevron-right"></i></button>
                                </div>
                                <div class="info-text">
                                    <p>Select text from the document and drag to form fields</p>
                                </div>
                            </div>

                            <div class="tab-content" id="fields-tab">
                                <div class="text-content" id="fields-content">
                                    <p>Upload a document to see detected fields</p>
                                </div>
                            </div>

                            <div class="tab-content" id="extracted-tab">
                                <div class="extracted-text-container">
                                    <div class="extracted-text-content" id="extracted-text-content">
                                        <p>Upload a document to see extracted text</p>
                                    </div>
                                </div>
                                <div class="info-text">
                                    <p>Click and drag any text to form fields</p>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-header">
                                <h3><i class="fas fa-file-alt"></i> Invoice Details</h3>
                                <p>Review and edit extracted information</p>
                            </div>
                            <form id="invoice-form">
                                <div id="form-fields-container">
                                    <div class="form-group">
                                        <label class="form-label">Approval Workflow</label>
                                        <div class="radio-group">
                                            <label class="radio-container">
                                                <input type="radio" name="approval-type" value="hierarchy" checked>
                                                <span class="radio-checkmark"></span>
                                                <span class="radio-label">Hierarchical (3 levels)</span>
                                            </label>
                                            <label class="radio-container">
                                                <input type="radio" name="approval-type" value="department">
                                                <span class="radio-checkmark"></span>
                                                <span class="radio-label">Department Approval</span>
                                            </label>
                                            <label class="radio-container">
                                                <input type="radio" name="approval-type" value="single">
                                                <span class="radio-checkmark"></span>
                                                <span class="radio-label">Single Approver</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="invoice-number" class="form-label">Invoice Number *</label>
                                        <div class="drop-area" id="invoice-number-drop" data-field="invoice-number">
                                            <input type="text" id="invoice-number" name="invoice-number" class="form-control" 
                                                   placeholder="Will auto-fill from document" autocomplete="off" readonly required>
                                            <span class="edit-hint">Right-click to edit</span>
                                        </div>
                                        <p class="info-text">Look for "Invoice Number:" in the document</p>
                                    </div>

                                    <div class="form-group">
                                        <label for="po-number" class="form-label">PO Number</label>
                                        <div class="drop-area" id="po-number-drop" data-field="po-number">
                                            <input type="text" id="po-number" name="po-number" class="form-control" 
                                                   placeholder="Will auto-fill from document" autocomplete="off" readonly>
                                            <span class="edit-hint">Right-click to edit</span>
                                        </div>
                                        <p class="info-text">Look for "PO Number:" in the document</p>
                                    </div>

                                    <div class="form-group">
                                        <label for="invoice-date" class="form-label">Invoice Date</label>
                                        <div class="drop-area" id="invoice-date-drop" data-field="invoice-date">
                                            <input type="date" id="invoice-date" name="invoice-date" class="form-control" readonly>
                                            <span class="edit-hint">Right-click to edit</span>
                                        </div>
                                        <p class="info-text">Look for "Invoice Date:" in the document</p>
                                    </div>

                                    <div class="form-group">
                                        <label for="payment-terms" class="form-label">Payment Terms</label>
                                        <div class="drop-area" id="payment-terms-drop" data-field="payment-terms">
                                            <input type="text" id="payment-terms" name="payment-terms" class="form-control" 
                                                   placeholder="Will auto-fill from document" autocomplete="off" readonly>
                                            <span class="edit-hint">Right-click to edit</span>
                                        </div>
                                        <p class="info-text">Look for "Payment Terms:" in the document</p>
                                    </div>

                                    <div class="form-group">
                                        <label for="total-amount" class="form-label">Total Amount *</label>
                                        <div class="drop-area" id="total-amount-drop" data-field="total-amount">
                                            <input type="text" id="total-amount" name="total-amount" class="form-control" 
                                                   placeholder="Will auto-fill from document" autocomplete="off" readonly required>
                                            <span class="edit-hint">Right-click to edit</span>
                                        </div>
                                        <p class="info-text">Look for "Total Amount:" in the document</p>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Vendor Information</label>
                                        <div class="drop-area" id="vendor-info-drop" data-field="vendor-info">
                                            <textarea id="vendor-info" name="vendor-info" class="form-control" rows="3" 
                                                      placeholder="Vendor details will auto-fill" autocomplete="off" readonly></textarea>
                                            <span class="edit-hint">Right-click to edit</span>
                                        </div>
                                    </div>

                                    <!-- Custom Fields Section -->
                                    <div class="form-group">
                                        <label class="form-label">Additional Fields</label>
                                        <div id="custom-fields-container">
                                            <!-- Custom fields will be added here -->
                                        </div>
                                        <button type="button" class="btn btn-outline" id="add-custom-field-btn">
                                            <i class="fas fa-plus"></i> Add Field
                                        </button>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Invoice Items</label>
                                        <div class="drop-area" id="invoice-items-drop">
                                            <div class="invoice-items-container" id="invoice-items-container">
                                                <!-- Items will be added here dynamically -->
                                            </div>
                                            <button type="button" class="add-item-btn" id="add-item-btn">
                                                <i class="fas fa-plus"></i> Add Item
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Amount Details Section -->
                                    <div class="form-group">
                                        <label class="form-label">Amount Details</label>
                                        <div class="amount-details-container">
                                            <div class="amount-row">
                                                <span class="amount-label">Subtotal:</span>
                                                <span class="amount-value" id="subtotal-amount">$0.00</span>
                                            </div>
                                            <div class="amount-row">
                                                <span class="amount-label">CGST (9%):</span>
                                                <span class="amount-value" id="cgst-amount">$0.00</span>
                                            </div>
                                            <div class="amount-row">
                                                <span class="amount-label">SGST (9%):</span>
                                                <span class="amount-value" id="sgst-amount">$0.00</span>
                                            </div>
                                            <div class="amount-row">
                                                <span class="amount-label">GST (18%):</span>
                                                <span class="amount-value" id="gst-amount">$0.00</span>
                                                <button type="button" class="btn btn-outline btn-sm" id="set-gst-btn">
                                                    <i class="fas fa-cog"></i> Set GST
                                                </button>
                                            </div>
                                            <div class="amount-row total-row">
                                                <span class="amount-label">Grand Total:</span>
                                                <span class="amount-value" id="grand-total-amount">$0.00</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-footer">
                                    <button type="submit" class="btn btn-primary btn-block" id="save-btn">
                                        <i class="fas fa-save"></i> Save Invoice
                                    </button>
                                    <div id="form-status" class="status-message"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- PO Section -->
                <section id="po-section" class="content-section">
                    <div class="section-header">
                        <h2><i class="fas fa-file-purchase"></i> Process PO</h2>
                        <p>Upload a purchase order PDF to extract and process data</p>
                    </div>

                    <div class="upload-area" id="po-drop-zone">
                        <div class="upload-content">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h3>Upload PO PDF</h3>
                            <p>Drag & drop your PO file here or click to browse</p>
                            <input type="file" id="po-pdf-upload" accept="application/pdf" style="display: none;">
                            <button class="btn btn-outline" id="po-browse-btn">Select File</button>
                        </div>
                        <div id="po-upload-status" class="status-message"></div>
                    </div>

                    <div id="po-document-info" class="document-info">
                        <strong>Current Document:</strong> <span id="po-current-filename">None</span>
                    </div>

                    <div class="processing-container">
                        <div class="document-viewer-container">
                            <div class="tab-container">
                                <div class="tab active" data-tab="po-viewer">Document Viewer</div>
                                <div class="tab" data-tab="po-select">Text Selection</div>
                                <div class="tab" data-tab="po-extracted">Extracted Text</div>
                                <div class="tab" data-tab="po-fields">Detected Fields</div>
                            </div>

                            <div class="tab-content active" id="po-viewer-tab">
                                <div id="po-pdf-container">
                                    <div class="zoom-controls">
                                        <button class="zoom-btn" id="po-zoom-in"><i class="fas fa-search-plus"></i></button>
                                        <button class="zoom-btn" id="po-zoom-out"><i class="fas fa-search-minus"></i></button>
                                        <span id="po-zoom-level">100%</span>
                                    </div>
                                    <div id="po-pdf-viewer"></div>
                                </div>
                                <div class="page-controls">
                                    <button class="page-btn" id="po-prev-page"><i class="fas fa-chevron-left"></i> Previous</button>
                                    <span id="po-page-info">Page 1 of 1</span>
                                    <button class="page-btn" id="po-next-page">Next <i class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>

                            <div class="tab-content" id="po-select-tab">
                                <div id="po-pdf-select-container">
                                    <div class="zoom-controls">
                                        <button class="zoom-btn" id="po-select-zoom-in"><i class="fas fa-search-plus"></i></button>
                                        <button class="zoom-btn" id="po-select-zoom-out"><i class="fas fa-search-minus"></i></button>
                                        <span id="po-select-zoom-level">100%</span>
                                    </div>
                                    <div id="po-pdf-select-viewer"></div>
                                </div>
                                <div class="page-controls">
                                    <button class="page-btn" id="po-select-prev-page"><i class="fas fa-chevron-left"></i> Previous</button>
                                    <span id="po-select-page-info">Page 1 of 1</span>
                                    <button class="page-btn" id="po-select-next-page">Next <i class="fas fa-chevron-right"></i></button>
                                </div>
                                <div class="info-text">
                                    <p>Select text from the document and drag to form fields</p>
                                </div>
                            </div>

                            <div class="tab-content" id="po-fields-tab">
                                <div class="text-content" id="po-fields-content">
                                    <p>Upload a document to see detected fields</p>
                                </div>
                            </div>

                            <div class="tab-content" id="po-extracted-tab">
                                <div class="extracted-text-container">
                                    <div class="extracted-text-content" id="po-extracted-text-content">
                                        <p>Upload a document to see extracted text</p>
                                    </div>
                                </div>
                                <div class="info-text">
                                    <p>Click and drag any text to form fields</p>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-header">
                                <h3><i class="fas fa-file-alt"></i> PO Details</h3>
                                <p>Review and edit extracted information</p>
                            </div>
                            <form id="po-form">
                                <div id="po-form-fields-container">
                                    <div class="form-group">
                                        <label class="form-label">Approval Workflow</label>
                                        <div class="radio-group">
                                            <label class="radio-container">
                                                <input type="radio" name="po-approval-type" value="hierarchy" checked>
                                                <span class="radio-checkmark"></span>
                                                <span class="radio-label">Hierarchical (3 levels)</span>
                                            </label>
                                            <label class="radio-container">
                                                <input type="radio" name="po-approval-type" value="single">
                                                <span class="radio-checkmark"></span>
                                                <span class="radio-label">Single Approver</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="po-po-number" class="form-label">PO Number *</label>
                                        <div class="drop-area" id="po-po-number-drop" data-field="po-po-number">
                                            <input type="text" id="po-po-number" name="po-number" class="form-control" 
                                                   placeholder="Will auto-fill from document" autocomplete="off" readonly required>
                                            <span class="edit-hint">Right-click to edit</span>
                                        </div>
                                        <p class="info-text">Look for "PO Number:" in the document</p>
                                    </div>

                                    <div class="form-group">
                                        <label for="po-po-date" class="form-label">PO Date</label>
                                        <div class="drop-area" id="po-po-date-drop" data-field="po-po-date">
                                            <input type="date" id="po-po-date" name="po-date" class="form-control" readonly>
                                            <span class="edit-hint">Right-click to edit</span>
                                        </div>
                                        <p class="info-text">Look for "PO Date:" in the document</p>
                                    </div>

                                    <div class="form-group">
                                        <label for="po-payment-terms" class="form-label">Payment Terms</label>
                                        <div class="drop-area" id="po-payment-terms-drop" data-field="po-payment-terms">
                                            <input type="text" id="po-payment-terms" name="payment-terms" class="form-control" 
                                                   placeholder="Will auto-fill from document" autocomplete="off" readonly>
                                            <span class="edit-hint">Right-click to edit</span>
                                        </div>
                                        <p class="info-text">Look for "Payment Terms:" in the document</p>
                                    </div>

                                    <div class="form-group">
                                        <label for="po-total-amount" class="form-label">Total Amount *</label>
                                        <div class="drop-area" id="po-total-amount-drop" data-field="po-total-amount">
                                            <input type="text" id="po-total-amount" name="total-amount" class="form-control" 
                                                   placeholder="Will auto-fill from document" autocomplete="off" readonly required>
                                            <span class="edit-hint">Right-click to edit</span>
                                        </div>
                                        <p class="info-text">Look for "Total Amount:" in the document</p>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Vendor Information</label>
                                        <div class="drop-area" id="po-vendor-info-drop" data-field="po-vendor-info">
                                            <textarea id="po-vendor-info" name="vendor-info" class="form-control" rows="3" 
                                                      placeholder="Vendor details will auto-fill" autocomplete="off" readonly></textarea>
                                            <span class="edit-hint">Right-click to edit</span>
                                        </div>
                                    </div>

                                    <!-- Custom Fields Section -->
                                    <div class="form-group">
                                        <label class="form-label">Additional Fields</label>
                                        <div id="po-custom-fields-container">
                                            <!-- Custom fields will be added here -->
                                        </div>
                                        <button type="button" class="btn btn-outline" id="po-add-custom-field-btn">
                                            <i class="fas fa-plus"></i> Add Field
                                        </button>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">PO Items</label>
                                        <div class="drop-area" id="po-items-drop">
                                            <div class="invoice-items-container" id="po-items-container">
                                                <!-- Items will be added here dynamically -->
                                            </div>
                                            <button type="button" class="add-item-btn" id="po-add-item-btn">
                                                <i class="fas fa-plus"></i> Add Item
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Amount Details Section -->
                                    <div class="form-group">
                                        <label class="form-label">Amount Details</label>
                                        <div class="amount-details-container">
                                            <div class="amount-row">
                                                <span class="amount-label">Subtotal:</span>
                                                <span class="amount-value" id="po-subtotal-amount">$0.00</span>
                                            </div>
                                            <div class="amount-row">
                                                <span class="amount-label">CGST (9%):</span>
                                                <span class="amount-value" id="po-cgst-amount">$0.00</span>
                                            </div>
                                            <div class="amount-row">
                                                <span class="amount-label">SGST (9%):</span>
                                                <span class="amount-value" id="po-sgst-amount">$0.00</span>
                                            </div>
                                            <div class="amount-row">
                                                <span class="amount-label">GST (18%):</span>
                                                <span class="amount-value" id="po-gst-amount">$0.00</span>
                                                <button type="button" class="btn btn-outline btn-sm" id="po-set-gst-btn">
                                                    <i class="fas fa-cog"></i> Set GST
                                                </button>
                                            </div>
                                            <div class="amount-row total-row">
                                                <span class="amount-label">Grand Total:</span>
                                                <span class="amount-value" id="po-grand-total-amount">$0.00</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-footer">
                                    <button type="submit" class="btn btn-primary btn-block" id="po-save-btn">
                                        <i class="fas fa-save"></i> Save PO
                                    </button>
                                    <div id="po-form-status" class="status-message"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                </section>


                <section id="user-management-section" class="content-section">
                    <div class="section-header">
                        <h2><i class="fas fa-user-shield"></i> User Management</h2>
                        <p>Manage all system users and their permissions</p>
                    </div>
                
                    <div class="table-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="user-search" placeholder="Search users...">
                        </div>
                        <div class="table-actions">
                            <button class="btn btn-primary" id="add-user-btn">
                                <i class="fas fa-plus"></i> Add User
                            </button>
                        </div>
                    </div>
                
                    <div class="table-responsive">
                        <table id="users-table" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Active</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded from server -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Invoices Table Section -->
                <section id="invoices-section" class="content-section">
                    <div class="section-header">
                        <h2><i class="fas fa-list"></i> Invoice Records</h2>
                        <p>View and manage all processed invoices</p>
                    </div>

                    <div class="table-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="invoice-search" placeholder="Search invoices...">
                        </div>
                        <div class="table-actions">
                            <button class="btn btn-outline" id="refresh-invoices">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table id="invoices-table" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Document #</th>
                                    <th>PO #</th>
                                    <th>Date</th>
                                    <th>Created Time</th>
                                    <th>Vendor</th>
                                    <th>Document Type</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded from server -->
                            </tbody>
                        </table>
                    </div>
                </section>
            
                <!-- Dashboard Section -->
                <section id="dashboard-section" class="content-section active">
                  <div class="section-header">
                    <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                    <p>Overview of invoice processing status</p>
                  </div>
                  
                  <div class="dashboard-content">
                    <!-- Overview Cards -->
                    <div class="dashboard-overview">
                      <div class="overview-card total" id="total-card">
                        <div class="card-icon">
                          <i class="fas fa-file-invoice"></i>
                        </div>
                        <div class="card-content">
                          <h3>Total Processed</h3>
                          <div class="card-value" id="total-count">0</div>
                        </div>
                      </div>
                      
                      <div class="overview-card approved" id="approved-card">
                        <div class="card-icon">
                          <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="card-content">
                          <h3>Approved</h3>
                          <div class="card-value" id="approved-count">0</div>
                        </div>
                      </div>
                      
                      <div class="overview-card pending" id="pending-card">
                        <div class="card-icon">
                          <i class="fas fa-clock"></i>
                        </div>
                        <div class="card-content">
                          <h3>Pending</h3>
                          <div class="card-value" id="pending-count">0</div>
                        </div>
                      </div>
                      
                      <div class="overview-card rejected" id="rejected-card">
                        <div class="card-icon">
                          <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="card-content">
                          <h3>Rejected</h3>
                          <div class="card-value" id="rejected-count">0</div>
                        </div>
                      </div>
                      
                      <div class="overview-card hold" id="hold-card">
                        <div class="card-icon">
                          <i class="fas fa-pause-circle"></i>
                        </div>
                        <div class="card-content">
                          <h3>On Hold</h3>
                          <div class="card-value" id="hold-count">0</div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="dashboard-recent">
                      <h3><i class="fas fa-history"></i> Recent Activity</h3>
                      <div class="recent-list" id="recent-activity">
                        <div class="loading-spinner">
                          <div class="spinner"></div>
                          <p>Loading activity...</p>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Status Charts -->
                    <div class="dashboard-charts">
                      <div class="chart-container">
                        <h3><i class="fas fa-chart-pie"></i> Status Distribution</h3>
                        <canvas id="status-chart"></canvas>
                      </div>
                      <div class="chart-container">
                        <h3><i class="fas fa-chart-line"></i> Weekly Processing</h3>
                        <canvas id="weekly-chart"></canvas>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Detailed View Section (hidden by default) -->
                  <div class="dashboard-detail" id="detail-view" style="display: none;">
                    <div class="detail-header">
                      <button class="btn btn-outline" id="back-to-overview">
                        <i class="fas fa-arrow-left"></i> Back to Overview
                      </button>
                      <h3 id="detail-title">Approved Invoices</h3>
                    </div>
                    
                    <div class="table-controls">
                      <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="dashboard-search" placeholder="Search invoices...">
                      </div>
                      <div class="table-actions">
                        <button class="btn btn-outline" id="refresh-dashboard">
                          <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                      </div>
                    </div>
                    
                    <div class="table-responsive">
                      <table id="dashboard-table" class="display" style="width:100%">
                        <thead>
                          <tr>
                            <th>Document #</th>
                            <th>PO #</th>
                            <th>Date</th>
                            <th>Created Time</th>
                            <th>Vendor</th>
                            <th>Document Type</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          <!-- Data will be loaded from server -->
                        </tbody>
                      </table>
                    </div>
                  </div>
                </section>

                <section id="vendor-master-section" class="content-section">
                    <div class="section-header">
                        <h2><i class="fas fa-users"></i> Vendor Master</h2>
                        <p>Manage vendor information and details</p>
                    </div>

                    <div class="vendor-master-tabs">
                        <div class="vendor-tab-header">
                            <button class="vendor-tab-btn active" data-tab="add-vendor">Add Vendor</button>
                            <button class="vendor-tab-btn" data-tab="add-details">Add Vendor Details</button>
                            <button class="vendor-tab-btn" data-tab="vendor-list">Vendor List</button>
                        </div>

                        <!-- Add Vendor Tab -->
                        <div class="vendor-tab-content active" id="add-vendor-tab">
                            <form id="vendor-basic-form" class="vendor-form">
                                <div class="form-group">
                                    <label for="vendor-id" class="form-label">Vendor ID *</label>
                                    <input type="text" id="vendor-id" name="vendor-id" class="form-control" required>
                                    <p class="info-text">Unique identifier for the vendor</p>
                                </div>

                                <div class="form-group">
                                    <label for="vendor-name" class="form-label">Vendor Name *</label>
                                    <input type="text" id="vendor-name" name="vendor-name" class="form-control" required>
                                </div>

                                <div class="form-group">
                                    <label for="vendor-email" class="form-label">Email *</label>
                                    <input type="email" id="vendor-email" name="vendor-email" class="form-control" required>
                                </div>

                                <div class="form-footer">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Create Vendor
                                    </button>
                                    <div id="vendor-basic-status" class="status-message"></div>
                                </div>
                            </form>
                        </div>

                        <!-- Add Vendor Details Tab -->
                        <div class="vendor-tab-content" id="add-details-tab">
                            <form id="vendor-details-form" class="vendor-form">
                                <div class="form-group">
                                    <label for="vendor-select" class="form-label">Select Vendor *</label>
                                    <select id="vendor-select" name="vendor-select" class="form-control" required>
                                        <option value="">-- Select Vendor --</option>
                                    </select>
                                </div>

                                <div class="vendor-details-container">
                                    <div class="vendor-details-section">
                                        <h4><i class="fas fa-info-circle"></i> Basic Information</h4>
                                        <div class="form-group">
                                            <label for="vendor-type" class="form-label">Vendor Type</label>
                                            <select id="vendor-type" name="vendor-type" class="form-control">
                                                <option value="">-- Select Type --</option>
                                                <option value="Manufacturer">Manufacturer</option>
                                                <option value="Supplier">Supplier</option>
                                                <option value="Service Provider">Service Provider</option>
                                                <option value="Distributor">Distributor</option>
                                                <option value="Contractor">Contractor</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="vendor-details-section">
                                        <h4><i class="fas fa-map-marker-alt"></i> Address Information</h4>
                                        <div class="form-group">
                                            <label for="street" class="form-label">Street Address *</label>
                                            <input type="text" id="street" name="street" class="form-control" required>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="city" class="form-label">City *</label>
                                                <input type="text" id="city" name="city" class="form-control" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="state" class="form-label">State *</label>
                                                <input type="text" id="state" name="state" class="form-control" required>
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="country" class="form-label">Country *</label>
                                                <input type="text" id="country" name="country" class="form-control" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="postal-code" class="form-label">Postal Code *</label>
                                                <input type="text" id="postal-code" name="postal-code" class="form-control" required>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="vendor-details-section">
                                        <h4><i class="fas fa-phone"></i> Contact Information</h4>
                                        <div class="form-group">
                                            <label for="contact-person" class="form-label">Contact Person</label>
                                            <input type="text" id="contact-person" name="contact-person" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label for="contact-number" class="form-label">Contact Number *</label>
                                            <input type="tel" id="contact-number" name="contact-number" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="alternate-number" class="form-label">Alternate Number</label>
                                            <input type="tel" id="alternate-number" name="alternate-number" class="form-control">
                                        </div>
                                    </div>

                                    <div class="vendor-details-section">
                                        <h4><i class="fas fa-file-invoice-dollar"></i> Tax Information</h4>
                                        <div class="form-group">
                                            <label for="pan-number" class="form-label">PAN Number *</label>
                                            <input type="text" id="pan-number" name="pan-number" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="gstin" class="form-label">GSTIN</label>
                                            <input type="text" id="gstin" name="gstin" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">TDS Applicable</label>
                                            <div class="radio-group">
                                                <label class="radio-container">
                                                    <input type="radio" name="tds-applicable" value="yes">
                                                    <span class="radio-checkmark"></span>
                                                    <span class="radio-label">Yes</span>
                                                </label>
                                                <label class="radio-container">
                                                    <input type="radio" name="tds-applicable" value="no" checked>
                                                    <span class="radio-checkmark"></span>
                                                    <span class="radio-label">No</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div id="tds-details" style="display: none;">
                                            <div class="form-group">
                                                <label for="tds-section" class="form-label">TDS Section</label>
                                                <select id="tds-section" name="tds-section" class="form-control">
                                                    <option value="">-- Select Section --</option>
                                                    <option value="192">192 - Salaries</option>
                                                    <option value="193">193 - Interest on securities</option>
                                                    <option value="194A">194A - Interest other than securities</option>
                                                    <option value="194C">194C - Payments to contractors</option>
                                                    <option value="194H">194H - Commission or brokerage</option>
                                                    <option value="194I">194I - Rent</option>
                                                    <option value="194IA">194IA - Transfer of immovable property</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="tds-rate" class="form-label">TDS Rate (%)</label>
                                                <input type="number" id="tds-rate" name="tds-rate" class="form-control" min="0" max="100" step="0.1" readonly>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="vendor-details-section">
                                        <h4><i class="fas fa-industry"></i> MSME Information</h4>
                                        <div class="form-group">
                                            <label class="form-label">MSME Registered</label>
                                            <div class="radio-group">
                                                <label class="radio-container">
                                                    <input type="radio" name="msme-registered" value="yes">
                                                    <span class="radio-checkmark"></span>
                                                    <span class="radio-label">Yes</span>
                                                </label>
                                                <label class="radio-container">
                                                    <input type="radio" name="msme-registered" value="no" checked>
                                                    <span class="radio-checkmark"></span>
                                                    <span class="radio-label">No</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div id="msme-details" style="display: none;">
                                            <div class="form-group">
                                                <label for="msme-number" class="form-label">MSME Number</label>
                                                <input type="text" id="msme-number" name="msme-number" class="form-control">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="vendor-details-section">
                                        <h4><i class="fas fa-university"></i> Bank Information</h4>
                                        <div class="form-group">
                                            <label for="bank-name" class="form-label">Bank Name *</label>
                                            <input type="text" id="bank-name" name="bank-name" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="account-number" class="form-label">Account Number *</label>
                                            <input type="text" id="account-number" name="account-number" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="account-holder" class="form-label">Account Holder Name *</label>
                                            <input type="text" id="account-holder" name="account-holder" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="ifsc-code" class="form-label">IFSC Code *</label>
                                            <input type="text" id="ifsc-code" name="ifsc-code" class="form-control" required>
                                        </div>
                                    </div>

                                    <div class="vendor-details-section">
                                        <h4><i class="fas fa-money-bill-wave"></i> Payment Information</h4>
                                        <div class="form-group">
                                            <label for="payment-terms" class="form-label">Payment Terms</label>
                                            <input type="text" id="payment-terms" name="payment-terms" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label for="currency" class="form-label">Currency</label>
                                            <select id="currency" name="currency" class="form-control">
                                                <option value="INR">Indian Rupee (INR)</option>
                                                <option value="USD">US Dollar (USD)</option>
                                                <option value="EUR">Euro (EUR)</option>
                                                <option value="GBP">British Pound (GBP)</option>
                                                <option value="AUD">Australian Dollar (AUD)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="payment-method" class="form-label">Preferred Payment Method</label>
                                            <select id="payment-method" name="payment-method" class="form-control">
                                                <option value="NEFT">NEFT</option>
                                                <option value="UPI">UPI</option>
                                                <option value="DD">Demand Draft</option>
                                                <option value="Cheque">Cheque</option>
                                                <option value="RTGS">RTGS</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="vendor-details-section">
                                        <h4><i class="fas fa-sticky-note"></i> Additional Information</h4>
                                        <div class="form-group">
                                            <label for="additional-notes" class="form-label">Notes</label>
                                            <textarea id="additional-notes" name="additional-notes" class="form-control" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-footer">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Vendor Details
                                    </button>
                                    <div id="vendor-details-status" class="status-message"></div>
                                </div>
                            </form>
                        </div>

                        <!-- Vendor List Tab -->
                        <div class="vendor-tab-content" id="vendor-list-tab">
                            <div class="table-controls">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="vendor-search" placeholder="Search vendors...">
                                </div>
                                <div class="table-actions">
                                    <button class="btn btn-outline" id="refresh-vendors">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                    <button class="btn btn-outline" id="export-vendors">
                                        <i class="fas fa-file-export"></i> Export
                                    </button>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table id="vendors-table" class="display" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th>Vendor ID</th>
                                            <th>Vendor Name</th>
                                            <th>Email</th>
                                            <th>Contact</th>
                                            <th>Type</th>
                                            <th>PAN</th>
                                            <th>GSTIN</th>
                                            <th>Created At</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be loaded from server -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Settings Section -->
                <section id="settings-section" class="content-section">
                    <div class="section-header">
                        <h2><i class="fas fa-cog"></i> Settings</h2>
                        <p>Configure system settings and preferences</p>
                    </div>
                    <div class="settings-redirect">
                        <a href="settings.html" class="btn btn-primary">
                            <i class="fas fa-external-link-alt"></i> Go to Settings Page
                        </a>
                        <a href="log.html" class="btn btn-primary">
                            <i class="fas fa-clipboard-check"></i> Go to log Page
                        </a>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="vendor-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Vendor Details</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="vendor-detail-container">
                    <div class="vendor-detail-section">
                        <h4><i class="fas fa-info-circle"></i> Basic Information</h4>
                        <div class="detail-row">
                            <span class="detail-label">Vendor ID:</span>
                            <span class="detail-value" id="detail-vendor-id"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vendor Name:</span>
                            <span class="detail-value" id="detail-vendor-name"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value" id="detail-vendor-email"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vendor Type:</span>
                            <span class="detail-value" id="detail-vendor-type"></span>
                        </div>
                    </div>

                    <div class="vendor-detail-section">
                        <h4><i class="fas fa-map-marker-alt"></i> Address Information</h4>
                        <div class="detail-row">
                            <span class="detail-label">Address:</span>
                            <span class="detail-value" id="detail-vendor-address"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">City/State:</span>
                            <span class="detail-value" id="detail-vendor-city-state"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Country/Postal:</span>
                            <span class="detail-value" id="detail-vendor-country-postal"></span>
                        </div>
                    </div>

                    <div class="vendor-detail-section">
                        <h4><i class="fas fa-phone"></i> Contact Information</h4>
                        <div class="detail-row">
                            <span class="detail-label">Contact Person:</span>
                            <span class="detail-value" id="detail-contact-person"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Contact Number:</span>
                            <span class="detail-value" id="detail-contact-number"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Alternate Number:</span>
                            <span class="detail-value" id="detail-alternate-number"></span>
                        </div>
                    </div>

                    <div class="vendor-detail-section">
                        <h4><i class="fas fa-file-invoice-dollar"></i> Tax Information</h4>
                        <div class="detail-row">
                            <span class="detail-label">PAN Number:</span>
                            <span class="detail-value" id="detail-pan-number"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">GSTIN:</span>
                            <span class="detail-value" id="detail-gstin"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">TDS Applicable:</span>
                            <span class="detail-value" id="detail-tds-applicable"></span>
                        </div>
                        <div class="detail-row" id="detail-tds-section-row" style="display: none;">
                            <span class="detail-label">TDS Section:</span>
                            <span class="detail-value" id="detail-tds-section"></span>
                        </div>
                        <div class="detail-row" id="detail-tds-rate-row" style="display: none;">
                            <span class="detail-label">TDS Rate:</span>
                            <span class="detail-value" id="detail-tds-rate"></span>
                        </div>
                    </div>

                    <div class="vendor-detail-section">
                        <h4><i class="fas fa-industry"></i> MSME Information</h4>
                        <div class="detail-row">
                            <span class="detail-label">MSME Registered:</span>
                            <span class="detail-value" id="detail-msme-registered"></span>
                        </div>
                        <div class="detail-row" id="detail-msme-number-row" style="display: none;">
                            <span class="detail-label">MSME Number:</span>
                            <span class="detail-value" id="detail-msme-number"></span>
                        </div>
                    </div>

                    <div class="vendor-detail-section">
                        <h4><i class="fas fa-university"></i> Bank Information</h4>
                        <div class="detail-row">
                            <span class="detail-label">Bank Name:</span>
                            <span class="detail-value" id="detail-bank-name"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Account Number:</span>
                            <span class="detail-value" id="detail-account-number"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Account Holder:</span>
                            <span class="detail-value" id="detail-account-holder"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">IFSC Code:</span>
                            <span class="detail-value" id="detail-ifsc-code"></span>
                        </div>
                    </div>

                    <div class="vendor-detail-section">
                        <h4><i class="fas fa-money-bill-wave"></i> Payment Information</h4>
                        <div class="detail-row">
                            <span class="detail-label">Payment Terms:</span>
                            <span class="detail-value" id="detail-payment-terms"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Currency:</span>
                            <span class="detail-value" id="detail-currency"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Payment Method:</span>
                            <span class="detail-value" id="detail-payment-method"></span>
                        </div>
                    </div>

                    <div class="vendor-detail-section">
                        <h4><i class="fas fa-sticky-note"></i> Additional Information</h4>
                        <div class="detail-row">
                            <span class="detail-label">Notes:</span>
                            <span class="detail-value" id="detail-additional-notes"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary modal-close">Close</button>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New User</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="user-name" class="form-label">Full Name *</label>
                    <input type="text" id="user-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="user-email" class="form-label">Email *</label>
                    <input type="email" id="user-email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="user-role" class="form-label">Role *</label>
                    <select id="user-role" class="form-control" required>
                        <option value="">Select Role</option>
                        <option value="AP">AP Team</option>
                        <option value="CFO">CFO Team</option>
                        <option value="Manager">Manager</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="user-password" class="form-label">Password *</label>
                    <input type="password" id="user-password" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="user-confirm-password" class="form-label">Confirm Password *</label>
                    <input type="password" id="user-confirm-password" class="form-control" required>
                </div>
                <div id="user-status" class="status-message"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancel</button>
                <button class="btn btn-primary" id="save-user-btn">Save User</button>
            </div>
        </div>
    </div>
    

    <!-- Invoice Detail Modal -->
    <div id="invoice-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-tabs">
                    <div class="modal-tab active" data-tab="document">Document</div>
                    <div class="modal-tab" data-tab="details">Invoice Details</div>
                </div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-tab-content active" id="document-tab">
                    <div id="modal-pdf-viewer"></div>
                    <div class="page-controls">
                        <button class="page-btn" id="modal-prev-page"><i class="fas fa-chevron-left"></i> Previous</button>
                        <span id="modal-page-info">Page 1 of 1</span>
                        <button class="page-btn" id="modal-next-page">Next <i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                
                <div class="modal-tab-content" id="details-tab">
                    <div class="invoice-detail-header">
                        <div>
                            <h4 id="invoice-number-display">Invoice #</h4>
                            <p class="invoice-date" id="invoice-date-display"></p>
                            <p class="invoice-date" id="created-at-display"></p>
                            <div id="invoice-status-display"></div>
                        </div>
                        <div class="invoice-total">
                            <span>Total Amount</span>
                            <h3 id="invoice-total-amount"></h3>
                        </div>
                    </div>
                    
                    <div class="invoice-detail-info">
                        <div>
                            <h5>Vendor Information</h5>
                            <p id="vendor-info-display"></p>
                            
                            <h5>Document Type</h5>
                            <p id="document-type-display"></p>
                        </div>
                        <div>
                            <h5>Payment Terms</h5>
                            <p id="payment-terms-display"></p>
                            
                            <h5>PO Number</h5>
                            <p id="po-number-display"></p>
                        </div>
                    </div>
                    
                    <div id="invoice-items-display">
                        <!-- Items will be loaded here -->
                    </div>

                    <!-- Amount Details Section in Modal -->
                    <div class="amount-details-section">
                        <h5>Amount Details</h5>
                        <div class="amount-details-container">
                            <div class="amount-row">
                                <span class="amount-label">Subtotal:</span>
                                <span class="amount-value" id="modal-subtotal-amount">$0.00</span>
                            </div>
                            <div class="amount-row">
                                <span class="amount-label">CGST (9%):</span>
                                <span class="amount-value" id="modal-cgst-amount">$0.00</span>
                            </div>
                            <div class="amount-row">
                                <span class="amount-label">SGST (9%):</span>
                                <span class="amount-value" id="modal-sgst-amount">$0.00</span>
                            </div>
                            <div class="amount-row">
                                <span class="amount-label">GST (18%):</span>
                                <span class="amount-value" id="modal-gst-amount">$0.00</span>
                                <button type="button" class="btn btn-outline btn-sm" id="modal-set-gst-btn">
                                    <i class="fas fa-cog"></i> Set GST
                                </button>
                            </div>
                            <div class="amount-row total-row">
                                <span class="amount-label">Grand Total:</span>
                                <span class="amount-value" id="modal-grand-total-amount">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Fields Section in Modal -->
                    <div id="custom-fields-display">
                        <!-- Custom fields will be loaded here -->
                    </div>

                    <!-- Attachments Section in Modal -->
                    <div id="attachments-display">
                        <h5>Attachments</h5>
                        <div id="attachments-list-display"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="edit-total-btn">
                    <i class="fas fa-edit"></i> Edit Total
                </button>
                <button class="btn btn-primary modal-close">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Total Modal -->
    <div id="edit-total-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Total Amount</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="edit-total-amount" class="form-label">New Total Amount *</label>
                    <input type="text" id="edit-total-amount" class="form-control" required>
                </div>
                <div id="edit-total-status" class="status-message"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancel</button>
                <button class="btn btn-primary" id="save-total-btn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Set GST Modal -->
    <div id="set-gst-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Set GST Rate</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="gst-rate" class="form-label">GST Rate (%)</label>
                    <input type="number" id="gst-rate" class="form-control" value="18" min="0" max="100" step="0.1">
                </div>
                <div id="gst-status" class="status-message"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancel</button>
                <button class="btn btn-primary" id="save-gst-btn">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Custom Field Modal -->
    <div id="add-field-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Custom Field</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="field-name" class="form-label">Field Name *</label>
                    <input type="text" id="field-name" class="form-control" required>
                </div>
                <div id="field-status" class="status-message"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancel</button>
                <button class="btn btn-primary" id="save-field-btn">Add Field</button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="loading-spinner">
        <div class="spinner"></div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu">
        <div class="context-menu-item" id="edit-field">Edit Field</div>
    </div>

    <script>
        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
    
        // Global variables
        let pdfDocument = null;
        let currentPage = 1;
        let selectPage = 1;
        let scale = 1.0;
        let selectScale = 1.0;
        let modalCurrentPage = 1;
        let modalScale = 1.0;
        let extractedText = [];
        let detectedFields = {};
        let allTextItems = [];
        let activeInput = null;
        let textLayer = null;
        let selectTextLayer = null;
        let selectedTextSpan = null;
        let isDraggingFromSelect = false;
        let gstRate = 18;
        let currentDocumentType = 'Invoice'; // 'Invoice' or 'PO'
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        const ALLOWED_FILE_TYPES = ['application/pdf', 'image/jpeg', 'image/png'];
        let invoicesTable = null; // Store DataTable instance
    
        // DOM elements
        const browseBtn = document.getElementById('browse-btn');
        const pdfUpload = document.getElementById('pdf-upload');
        const dropZone = document.getElementById('drop-zone');
        const uploadStatus = document.getElementById('upload-status');
        const currentFilename = document.getElementById('current-filename');
        const documentInfo = document.getElementById('document-info');
        const zoomLevel = document.getElementById('zoom-level');
        const selectZoomLevel = document.getElementById('select-zoom-level');
        const addItemBtn = document.getElementById('add-item-btn');
        const formFieldsContainer = document.getElementById('form-fields-container');
        const extractedTextContent = document.getElementById('extracted-text-content');
        const newInvoiceBtn = document.getElementById('new-invoice-btn');
        const saveBtn = document.getElementById('save-btn');
        const formStatus = document.getElementById('form-status');
        const contextMenu = document.getElementById('context-menu');
        const editFieldBtn = document.getElementById('edit-field');
        const addCustomFieldBtn = document.getElementById('add-custom-field-btn');
        const setGstBtn = document.getElementById('set-gst-btn');
        const modalSetGstBtn = document.getElementById('modal-set-gst-btn');
        const totalAmountInput = document.getElementById('total-amount');
        const addAttachmentBtn = document.getElementById('add-attachment-btn');
        const fileAttachments = document.getElementById('file-attachments');
        const attachmentsList = document.getElementById('attachments-list');
        
        // PO elements
        const poBrowseBtn = document.getElementById('po-browse-btn');
        const poPdfUpload = document.getElementById('po-pdf-upload');
        const poDropZone = document.getElementById('po-drop-zone');
        const poUploadStatus = document.getElementById('po-upload-status');
        const poCurrentFilename = document.getElementById('po-current-filename');
        const poDocumentInfo = document.getElementById('po-document-info');
        const poSaveBtn = document.getElementById('po-save-btn');

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateZoomDisplay();
            
            if (window.location.hash) {
                showSection(window.location.hash);
            }
            
            // Initialize DataTables for invoices if not already initialized
            if (!$.fn.DataTable.isDataTable('#invoices-table')) {
                invoicesTable = $('#invoices-table').DataTable({
                    ajax: {
                        url: '/api/invoices',
                        dataSrc: ''
                    },
                    columns: [
                        { data: 'documentNumber' },
                        { data: 'poNumber' },
                        { data: 'date' },
                        { data: 'createdAt' },
                        { data: 'vendor' },
                        { data: 'documentType' },
                        { data: 'totalAmount' },
                        { data: 'status' },
                        { 
                            data: null,
                            render: function(data, type, row) {
                                return `<button class="btn btn-sm btn-view" data-id="${row.id}">View</button>`;
                            }
                        }
                    ]
                });
            }
        });
    
        function setupEventListeners() {
            // Navigation links
            document.querySelectorAll('.sidebar nav a:not(.process-option)').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection(this.getAttribute('href'));
                });
            });
            
            // Process option links
            document.querySelectorAll('.process-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentDocumentType = this.dataset.type;
                    showSection(this.getAttribute('href'));
                    resetForm();
                    document.getElementById('page-title').textContent = `Process ${currentDocumentType}`;
                });
            });
            
            // New invoice button
            newInvoiceBtn.addEventListener('click', function() {
                showSection('#invoice-section');
                resetForm();
            });
            
            // Tab functionality
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabPrefix = this.closest('.document-viewer-container').id.includes('po') ? 'po-' : '';
                    
                    document.querySelectorAll(`.tab[data-tab^="${tabPrefix}"]`).forEach(t => t.classList.remove('active'));
                    document.querySelectorAll(`.tab-content[id^="${tabPrefix}"]`).forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(`${this.dataset.tab}-tab`).classList.add('active');
                });
            });
            
            // Browse button click handler
            browseBtn.addEventListener('click', function() {
                pdfUpload.click();
            });
            
            poBrowseBtn.addEventListener('click', function() {
                poPdfUpload.click();
            });
            
            // File input change handler
            pdfUpload.addEventListener('change', handleFileSelect);
            poPdfUpload.addEventListener('change', handlePoFileSelect);
            
            // Drag and drop handlers
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            poDropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', function() {
                this.classList.remove('dragover');
            });
            
            poDropZone.addEventListener('dragleave', function() {
                this.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                
                if (e.dataTransfer.files.length) {
                    pdfUpload.files = e.dataTransfer.files;
                    handleFileSelect({ target: pdfUpload });
                }
            });
            
            poDropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                
                if (e.dataTransfer.files.length) {
                    poPdfUpload.files = e.dataTransfer.files;
                    handlePoFileSelect({ target: poPdfUpload });
                }
            });
            
            // Zoom controls
            document.getElementById('zoom-in').addEventListener('click', function() { zoomIn('viewer'); });
            document.getElementById('zoom-out').addEventListener('click', function() { zoomOut('viewer'); });
            document.getElementById('select-zoom-in').addEventListener('click', function() { zoomIn('select'); });
            document.getElementById('select-zoom-out').addEventListener('click', function() { zoomOut('select'); });
            document.getElementById('po-zoom-in').addEventListener('click', function() { zoomIn('po-viewer'); });
            document.getElementById('po-zoom-out').addEventListener('click', function() { zoomOut('po-viewer'); });
            document.getElementById('po-select-zoom-in').addEventListener('click', function() { zoomIn('po-select'); });
            document.getElementById('po-select-zoom-out').addEventListener('click', function() { zoomOut('po-select'); });
            
            // Page navigation
            document.getElementById('prev-page').addEventListener('click', function() { goToPrevPage('viewer'); });
            document.getElementById('next-page').addEventListener('click', function() { goToNextPage('viewer'); });
            document.getElementById('select-prev-page').addEventListener('click', function() { goToPrevPage('select'); });
            document.getElementById('select-next-page').addEventListener('click', function() { goToNextPage('select'); });
            document.getElementById('po-prev-page').addEventListener('click', function() { goToPrevPage('po-viewer'); });
            document.getElementById('po-next-page').addEventListener('click', function() { goToNextPage('po-viewer'); });
            document.getElementById('po-select-prev-page').addEventListener('click', function() { goToPrevPage('po-select'); });
            document.getElementById('po-select-next-page').addEventListener('click', function() { goToNextPage('po-select'); });
            
            // Add item button
            addItemBtn.addEventListener('click', addInvoiceItem);
            document.getElementById('po-add-item-btn').addEventListener('click', addPoItem);
            
            // Add custom field button
            addCustomFieldBtn.addEventListener('click', function() {
                document.getElementById('add-field-modal').style.display = 'flex';
            });
            
            document.getElementById('po-add-custom-field-btn').addEventListener('click', function() {
                document.getElementById('add-field-modal').style.display = 'flex';
            });
            
            // Set GST button
            setGstBtn.addEventListener('click', function() {
                document.getElementById('gst-rate').value = gstRate;
                document.getElementById('set-gst-modal').style.display = 'flex';
            });
            
            document.getElementById('po-set-gst-btn').addEventListener('click', function() {
                document.getElementById('gst-rate').value = gstRate;
                document.getElementById('set-gst-modal').style.display = 'flex';
            });
            
            // Modal Set GST button
            modalSetGstBtn.addEventListener('click', function() {
                document.getElementById('gst-rate').value = gstRate;
                document.getElementById('set-gst-modal').style.display = 'flex';
            });
            
            // Form submission
            document.getElementById('invoice-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveDocument();
            });
            
            document.getElementById('po-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveDocument();
            });
            
            // Total amount input change handler
            totalAmountInput.addEventListener('change', updateAmountDetails);
            document.getElementById('po-total-amount').addEventListener('change', updatePoAmountDetails);
            
            // Setup drag and drop for form fields
            document.querySelectorAll('.drop-area').forEach(dropArea => {
                dropArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('highlight');
                    e.dataTransfer.dropEffect = 'copy';
                });
                
                dropArea.addEventListener('dragleave', function() {
                    this.classList.remove('highlight');
                });
                
                dropArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('highlight');
                    
                    const text = e.dataTransfer.getData('text/plain');
                    const fieldId = this.dataset.field;
                    
                    if (text) {
                        if (fieldId) {
                            const input = document.getElementById(fieldId);
                            if (input) {
                                input.value = text;
                                
                                this.classList.add('field-match');
                                setTimeout(() => {
                                    this.classList.remove('field-match');
                                }, 1000);
                                
                                if (fieldId === 'total-amount' || fieldId === 'po-total-amount') {
                                    if (fieldId === 'total-amount') {
                                        updateAmountDetails();
                                    } else {
                                        updatePoAmountDetails();
                                    }
                                }
                            }
                        } else if (this.id === 'invoice-items-drop' || this.id === 'po-items-drop') {
                            const activeItemField = document.querySelector('.item-card input:focus');
                            if (activeItemField) {
                                activeItemField.value = text;
                            }
                        }
                    }
                });
            });
            
            // Document mouse events for text selection
            document.addEventListener('mousedown', function(e) {
                if (e.target.closest('#pdf-select-viewer span') || 
                    e.target.closest('#extracted-text-content span') ||
                    e.target.closest('#po-pdf-select-viewer span') ||
                    e.target.closest('#po-extracted-text-content span')) {
                    isDraggingFromSelect = true;
                    selectedTextSpan = e.target.closest('span');
                }
            });
            
            document.addEventListener('mouseup', function() {
                isDraggingFromSelect = false;
            });
            
            // Setup drag events for extracted text
            extractedTextContent.addEventListener('mousedown', function(e) {
                if (e.target.tagName === 'SPAN') {
                    e.target.classList.add('selected');
                    selectedTextSpan = e.target;
                }
            });
            
            extractedTextContent.addEventListener('dragstart', function(e) {
                if (e.target.tagName === 'SPAN') {
                    e.dataTransfer.setData('text/plain', e.target.textContent);
                    e.dataTransfer.effectAllowed = 'copy';
                }
            });
            
            // Right-click context menu for form fields
            document.querySelectorAll('#form-fields-container input, #form-fields-container textarea, #po-form-fields-container input, #po-form-fields-container textarea').forEach(input => {
                input.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    showContextMenu(e, this);
                });
            });
    
            // Context menu item click
            editFieldBtn.addEventListener('click', function() {
                if (activeInput) {
                    activeInput.removeAttribute('readonly');
                    activeInput.focus();
                }
                hideContextMenu();
            });
    
            // Hide context menu when clicking elsewhere
            document.addEventListener('click', function() {
                hideContextMenu();
            });
    
            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', closeModal);
            });
    
            // Save field button
            document.getElementById('save-field-btn').addEventListener('click', addCustomField);
            
            // Add attachment button
            addAttachmentBtn.addEventListener('click', function() {
                fileAttachments.click();
            });
            
            // File attachment change handler
            fileAttachments.addEventListener('change', handleFileAttachments);
            
            // Refresh invoices button
            document.getElementById('refresh-invoices').addEventListener('click', function() {
                $('#invoices-table').DataTable().ajax.reload();
            });
        }
    
        // Show context menu
        function showContextMenu(e, input) {
            e.preventDefault();
            activeInput = input;
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;
        }
    
        // Hide context menu
        function hideContextMenu() {
            contextMenu.style.display = 'none';
            activeInput = null;
        }
        
        // Show section based on hash
        function showSection(sectionId) {
            window.location.hash = sectionId;
            
            const titleMap = {
                '#invoice-section': 'Process Invoice',
                '#po-section': 'Process PO',
                '#invoices-section': 'Invoice Records',
                '#settings-section': 'System Settings',
                '#dashboard-section': 'Dashboard'
            };
            
            document.getElementById('page-title').textContent = titleMap[sectionId] || 'Invoice Processor';
            
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelector(sectionId).classList.add('active');
            
            document.querySelectorAll('.sidebar nav li').forEach(li => {
                li.classList.remove('active');
            });
            
            const navLink = document.querySelector(`.sidebar nav a[href="${sectionId}"]`);
            if (navLink) {
                navLink.parentElement.classList.add('active');
            } else {
                // For dropdown items, highlight the parent
                const dropdownItem = document.querySelector(`.dropdown-menu a[href="${sectionId}"]`);
                if (dropdownItem) {
                    dropdownItem.closest('.dropdown').classList.add('active');
                }
            }
        }
        
        // Handle file select for invoices
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/pdf') {
                showStatus('Please upload a PDF file', 'error', uploadStatus);
                return;
            }
            
            currentFilename.textContent = file.name;
            documentInfo.style.display = 'block';
            
            const fileReader = new FileReader();
            
            fileReader.onload = function() {
                const typedarray = new Uint8Array(this.result);
                
                showStatus('Processing document...', 'success', uploadStatus);
                
                pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
                    pdfDocument = pdf;
                    showStatus('Document loaded successfully!', 'success', uploadStatus);
                    
                    currentPage = 1;
                    selectPage = 1;
                    scale = 1.0;
                    selectScale = 1.0;
                    extractedText = [];
                    detectedFields = {};
                    allTextItems = [];
                    
                    document.getElementById('pdf-viewer').innerHTML = '';
                    document.getElementById('pdf-select-viewer').innerHTML = '';
                    document.getElementById('fields-content').innerHTML = '';
                    document.getElementById('invoice-items-container').innerHTML = '';
                    document.getElementById('custom-fields-container').innerHTML = '';
                    extractedTextContent.innerHTML = '';
                    
                    renderPage(currentPage, 'viewer');
                    renderPage(selectPage, 'select');
                    
                    extractTextFromPDF(pdf);
                    
                    updatePageInfo('viewer');
                    updatePageInfo('select');
                    updateZoomDisplay();
                }).catch(function(error) {
                    showStatus('Error loading PDF: ' + error.message, 'error', uploadStatus);
                });
            };
            
            fileReader.readAsArrayBuffer(file);
        }
        
        // Handle file select for POs
        function handlePoFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/pdf') {
                showStatus('Please upload a PDF file', 'error', poUploadStatus);
                return;
            }
            
            poCurrentFilename.textContent = file.name;
            poDocumentInfo.style.display = 'block';
            
            const fileReader = new FileReader();
            
            fileReader.onload = function() {
                const typedarray = new Uint8Array(this.result);
                
                showStatus('Processing document...', 'success', poUploadStatus);
                
                pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
                    pdfDocument = pdf;
                    showStatus('Document loaded successfully!', 'success', poUploadStatus);
                    
                    currentPage = 1;
                    selectPage = 1;
                    scale = 1.0;
                    selectScale = 1.0;
                    extractedText = [];
                    detectedFields = {};
                    allTextItems = [];
                    
                    document.getElementById('po-pdf-viewer').innerHTML = '';
                    document.getElementById('po-pdf-select-viewer').innerHTML = '';
                    document.getElementById('po-fields-content').innerHTML = '';
                    document.getElementById('po-items-container').innerHTML = '';
                    document.getElementById('po-custom-fields-container').innerHTML = '';
                    document.getElementById('po-extracted-text-content').innerHTML = '';
                    
                    renderPage(currentPage, 'po-viewer');
                    renderPage(selectPage, 'po-select');
                    
                    extractTextFromPDF(pdf, true);
                    
                    updatePageInfo('po-viewer');
                    updatePageInfo('po-select');
                    updateZoomDisplay();
                }).catch(function(error) {
                    showStatus('Error loading PDF: ' + error.message, 'error', poUploadStatus);
                });
            };
            
            fileReader.readAsArrayBuffer(file);
        }
        
        // Handle file attachments
        function handleFileAttachments(e) {
            const files = e.target.files;
            attachmentsList.innerHTML = '';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!ALLOWED_FILE_TYPES.includes(file.type)) {
                    showStatus(`File type not allowed: ${file.name}`, 'error', uploadStatus);
                    continue;
                }
                
                if (file.size > MAX_FILE_SIZE) {
                    showStatus(`File too large (max 5MB): ${file.name}`, 'error', uploadStatus);
                    continue;
                }
                
                const fileItem = document.createElement('div');
                fileItem.className = 'attachment-item';
                fileItem.innerHTML = `
                    <span>${file.name}</span>
                    <button type="button" class="remove-attachment" data-index="${i}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                attachmentsList.appendChild(fileItem);
            }
            
            // Add remove attachment handlers
            document.querySelectorAll('.remove-attachment').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    const files = document.getElementById('file-attachments').files;
                    const newFiles = Array.from(files).filter((_, i) => i !== index);
                    
                    // Create new FileList (simulated)
                    const dataTransfer = new DataTransfer();
                    newFiles.forEach(file => dataTransfer.items.add(file));
                    document.getElementById('file-attachments').files = dataTransfer.files;
                    
                    // Update display
                    this.parentElement.remove();
                });
            });
        }
        
        // Render PDF page with selectable text layer
        function renderPage(pageNum, type = 'viewer') {
            if (!pdfDocument) return;
            
            const viewerId = type.includes('po') ? 
                (type.includes('select') ? 'po-pdf-select-viewer' : 'po-pdf-viewer') : 
                (type.includes('select') ? 'pdf-select-viewer' : 'pdf-viewer');
                
            const currentScale = type.includes('po') ? 
                (type.includes('select') ? selectScale : scale) : 
                (type.includes('select') ? selectScale : scale);
            
            pdfDocument.getPage(pageNum).then(function(page) {
                const viewport = page.getViewport({ scale: currentScale });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                const viewer = document.getElementById(viewerId);
                viewer.innerHTML = '';
                viewer.appendChild(canvas);
                
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                page.render(renderContext).promise.then(function() {
                    return page.getTextContent().then(function(textContent) {
                        const textLayerDiv = document.createElement('div');
                        textLayerDiv.className = 'text-layer';
                        
                        pdfjsLib.renderTextLayer({
                            textContent: textContent,
                            container: textLayerDiv,
                            viewport: viewport,
                            textDivs: []
                        });
                        
                        viewer.appendChild(textLayerDiv);
                        
                        if (type.includes('select')) {
                            selectTextLayer = textLayerDiv;
                        } else {
                            textLayer = textLayerDiv;
                        }
                        
                        const textSpans = textLayerDiv.querySelectorAll('span');
                        textSpans.forEach(span => {
                            span.draggable = true;
                            
                            span.addEventListener('dragstart', function(e) {
                                e.dataTransfer.setData('text/plain', this.textContent);
                                e.dataTransfer.effectAllowed = 'copy';
                            });
                            
                            span.addEventListener('click', function() {
                                if (selectedTextSpan) {
                                    selectedTextSpan.classList.remove('selected');
                                }
                                this.classList.add('selected');
                                selectedTextSpan = this;
                            });
                        });
                    });
                });
            });
        }
        
        // Extract text from PDF
        function extractTextFromPDF(pdf, isPo = false) {
            extractedText = [];
            detectedFields = {};
            allTextItems = [];
            const numPages = pdf.numPages;
            let promises = [];
            
            for (let i = 1; i <= numPages; i++) {
                promises.push(
                    pdf.getPage(i).then(function(page) {
                        return page.getTextContent().then(function(textContent) {
                            let pageText = '';
                            let pageItems = [];
                            let formattedText = '';
                            
                            textContent.items.forEach(function(textItem) {
                                const text = textItem.str.trim();
                                if (text) {
                                    pageText += text + ' ';
                                    pageItems.push({
                                        text: text,
                                        transform: textItem.transform,
                                        page: i
                                    });
                                    allTextItems.push(text);
                                    
                                    formattedText += `<span draggable="true">${text}</span> `;
                                }
                                
                                if (textItem.hasEOL) {
                                    formattedText += '\n';
                                }
                            });
                            
                            extractedText.push({
                                page: i,
                                text: pageText,
                                formattedText: formattedText,
                                items: pageItems
                            });
                            
                            detectFields(pageText, pageItems, isPo);
                        });
                    })
                );
            }
            
            Promise.all(promises).then(function() {
                console.log('Text extraction complete');
                
                if (isPo) {
                    displayExtractedText(true);
                    displayDetectedFields(true);
                    autoFillPoForm();
                } else {
                    displayExtractedText();
                    displayDetectedFields();
                    autoFillForm();
                }
            });
        }
        
        // Display extracted text with formatting
        function displayExtractedText(isPo = false) {
            const contentId = isPo ? 'po-extracted-text-content' : 'extracted-text-content';
            const contentElement = document.getElementById(contentId);
            contentElement.innerHTML = '';
            
            extractedText.forEach(page => {
                const pageHeader = document.createElement('div');
                pageHeader.style.fontWeight = 'bold';
                pageHeader.style.margin = '10px 0 5px 0';
                pageHeader.textContent = `Page ${page.page}:`;
                contentElement.appendChild(pageHeader);
                
                const pageContent = document.createElement('div');
                pageContent.innerHTML = page.formattedText;
                contentElement.appendChild(pageContent);
                
                pageContent.querySelectorAll('span').forEach(span => {
                    span.addEventListener('dragstart', function(e) {
                        e.dataTransfer.setData('text/plain', this.textContent);
                        e.dataTransfer.effectAllowed = 'copy';
                    });
                    
                    span.addEventListener('click', function() {
                        if (selectedTextSpan) {
                            selectedTextSpan.classList.remove('selected');
                        }
                        this.classList.add('selected');
                        selectedTextSpan = this;
                    });
                });
            });
        }
        
        // Detect fields in text
        function detectFields(text, textItems, isPo = false) {
            const fieldPatterns = isPo ? {
                'po-number': /(PO\s*Number|Purchase\s*Order|Order\s*No\.?)\s*[:#]?\s*([A-Z0-9-]+)/i,
                'po-date': /(PO\s*Date|Date\s*of\s*Order|Date)\s*[:]?\s*((\d{1,2}[\/\-\s](\d{1,2}|[A-Za-z]+)[\/\-\s]\d{2,4})|([A-Za-z]+[\/\-\s]\d{1,2}[\/\-\s]\d{2,4})|(\d{1,2}\s+[A-Za-z]+\s+\d{2,4}))/i,
                'total-amount': /(Total\s*Amount|Amount\s*Due|Grand\s*Total|Total)\s*[:]?\s*([$\u20AC\u00A3]?\s*[\d,]+\.?\d*)/i,
                'vendor-info': /From:\s*([\s\S]*?)(?=To:)/i
            } : {
                'invoice-number': /(Invoice\s*Number|Order\s*ID|Invoice\s*Details|Invoice\s*No\.?)\s*[:#]?\s*([A-Z0-9\-\/]+)/i,
                'po-number': /(PO\s*Number|Purchase\s*Order|Order\s*No\.?)\s*[:#]?\s*([A-Z0-9-]+)/i,
                'invoice-date': /(Invoice\s*Date|Date\s*of\s*Invoice|Date)\s*[:]?\s*((\d{1,2}[\/\-\s](\d{1,2}|[A-Za-z]+)[\/\-\s]\d{2,4})|([A-Za-z]+[\/\-\s]\d{1,2}[\/\-\s]\d{2,4})|(\d{1,2}\s+[A-Za-z]+\s+\d{2,4}))/i,
                'total-amount': /(Total\s*Amount|Amount\s*Due|Grand\s*Total|Total)\s*[:]?\s*([$\u20AC\u00A3]?\s*[\d,]+\.?\d*)/i,
                'vendor-info': /From:\s*([\s\S]*?)(?=To:)/i
            };
    
            if (!detectedFields['payment-terms']) {
                const paymentTermsMatch = text.match(/(?:Payment\s*Terms)\s*[:]?\s*(Net\s*15)/i);
                if (paymentTermsMatch) {
                    detectedFields['payment-terms'] = {
                        value: paymentTermsMatch[1].trim(),
                        confidence: 'high',
                        rawText: paymentTermsMatch[0]
                    };
                } else {
                    const paymentFooterMatch = text.match(/Please\s*make\s*payment\s*within\s*(\d+)\s*days/i);
                    if (paymentFooterMatch) {
                        detectedFields['payment-terms'] = {
                            value: `Net ${paymentFooterMatch[1]}`,
                            confidence: 'medium',
                            rawText: paymentFooterMatch[0]
                        };
                    }
                }
            }
    
            if (!detectedFields[isPo ? 'po-date' : 'invoice-date']) {
                const datePattern = /(\d{1,2}[\/\-\s](\d{1,2}|[A-Za-z]+)[\/\-\s]\d{2,4})|([A-Za-z]+[\/\-\s]\d{1,2}[\/\-\s]\d{2,4})|(\d{1,2}\s+[A-Za-z]+\s+\d{2,4})/i;
                const dateMatch = text.match(datePattern);
                
                if (dateMatch) {
                    detectedFields[isPo ? 'po-date' : 'invoice-date'] = {
                        value: dateMatch[0].trim(),
                        confidence: 'medium',
                        rawText: dateMatch[0]
                    };
                }
            }
    
            const tablePattern = /Description\s*Quantity\s*Unit\s*Price\s*Total[\s\S]*?(?=Subtotal|Total|GST)/i;
            const tableMatch = text.match(tablePattern);
            if (tableMatch) {
                detectedFields['invoice-items'] = {
                    value: tableMatch[0],
                    confidence: 'high',
                    rawText: tableMatch[0]
                };
            }
            
            for (const [field, pattern] of Object.entries(fieldPatterns)) {
                const match = text.match(pattern);
                if (match && !detectedFields[field]) {
                    detectedFields[field] = {
                        value: match[2] || match[1],
                        confidence: 'high',
                        rawText: match[0]
                    };
                }
            }
            
            if (!detectedFields['vendor-info']) {
                const vendorMatch = text.match(/(?:From|Supplier|Vendor):\s*([\s\S]*?)(?:\n\s*\n|\n\s*[A-Z][a-z])/i);
                if (vendorMatch) {
                    detectedFields['vendor-info'] = {
                        value: vendorMatch[1].trim(),
                        confidence: 'medium',
                        rawText: vendorMatch[0]
                    };
                }
            }
        }
        
        // Auto-fill form with detected fields
        function autoFillForm() {
            for (const [field, data] of Object.entries(detectedFields)) {
                const element = document.getElementById(field);
                if (!element) continue;
                
                if (field === 'invoice-items') {
                    parseTableData(data.rawText);
                } else if (field.endsWith('-date')) {
                    element.value = normalizeDate(data.value);
                } else {
                    element.value = data.value;
                }
                
                const dropArea = document.getElementById(`${field}-drop`);
                if (dropArea) {
                    dropArea.classList.add('field-match');
                    setTimeout(() => {
                        dropArea.classList.remove('field-match');
                    }, 2000);
                }
            }
    
            if (detectedFields['total-amount']) {
                updateAmountDetails();
            }
        }
        
        // Auto-fill PO form with detected fields
        function autoFillPoForm() {
            for (const [field, data] of Object.entries(detectedFields)) {
                const poField = field.replace('invoice-', 'po-').replace('date', 'po-date');
                const element = document.getElementById(poField);
                if (!element) continue;
                
                if (field === 'invoice-items') {
                    parsePoTableData(data.rawText);
                } else if (field.endsWith('-date')) {
                    element.value = normalizeDate(data.value);
                } else {
                    element.value = data.value;
                }
                
                const dropArea = document.getElementById(`${poField}-drop`);
                if (dropArea) {
                    dropArea.classList.add('field-match');
                    setTimeout(() => {
                        dropArea.classList.remove('field-match');
                    }, 2000);
                }
            }
    
            if (detectedFields['total-amount']) {
                updatePoAmountDetails();
            }
        }
        
        // Parse table data from text with improved method
        function parseTableData(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            
            let startIndex = lines.findIndex(line => 
                line.includes('Description') && 
                line.includes('Quantity') && 
                line.includes('Unit Price') && 
                line.includes('Total')
            );
            
            if (startIndex === -1) return;
            
            for (let i = startIndex + 1; i < lines.length; i++) {
                const line = lines[i];
                
                if (line.match(/Description|Quantity|Unit Price|Total|Subtotal|GST|Total Amount/i)) {
                    continue;
                }
                
                const parts = line.split(/\s{2,}/).filter(part => part.trim() !== '');
                
                if (parts.length >= 4) {
                    addInvoiceItem({
                        description: parts[0].trim(),
                        quantity: parts[1].trim(),
                        unitPrice: parts[2].trim(),
                        total: parts[3].trim()
                    });
                }
            }
        }
        
        // Parse PO table data
        function parsePoTableData(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            
            let startIndex = lines.findIndex(line => 
                line.includes('Description') && 
                line.includes('Quantity') && 
                line.includes('Unit Price') && 
                line.includes('Total')
            );
            
            if (startIndex === -1) return;
            
            for (let i = startIndex + 1; i < lines.length; i++) {
                const line = lines[i];
                
                if (line.match(/Description|Quantity|Unit Price|Total|Subtotal|GST|Total Amount/i)) {
                    continue;
                }
                
                const parts = line.split(/\s{2,}/).filter(part => part.trim() !== '');
                
                if (parts.length >= 4) {
                    addPoItem({
                        description: parts[0].trim(),
                        quantity: parts[1].trim(),
                        unitPrice: parts[2].trim(),
                        total: parts[3].trim()
                    });
                }
            }
        }
        
        // Add an invoice item card
        function addInvoiceItem(data = {}) {
            const container = document.getElementById('invoice-items-container');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-card';
            
            itemDiv.innerHTML = `
                <div class="item-field">
                    <label>Description</label>
                    <input type="text" value="${data.description || ''}" class="item-description" readonly>
                </div>
                <div class="item-field">
                    <label>Quantity</label>
                    <input type="text" value="${data.quantity || ''}" class="item-quantity" readonly>
                </div>
                <div class="item-field">
                    <label>Unit Price</label>
                    <input type="text" value="${data.unitPrice || ''}" class="item-unit-price" readonly>
                </div>
                <div class="item-field">
                    <label>Total</label>
                    <input type="text" value="${data.total || ''}" class="item-total" readonly>
                </div>
                <button type="button" class="remove-item-btn"><i class="fas fa-times"></i></button>
            `;
            
            itemDiv.querySelector('.remove-item-btn').addEventListener('click', function() {
                itemDiv.remove();
            });
            
            itemDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.parentElement.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
                });
                
                input.addEventListener('dragleave', function() {
                    this.parentElement.style.backgroundColor = '';
                });
                
                input.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.parentElement.style.backgroundColor = '';
                    const text = e.dataTransfer.getData('text/plain');
                    if (text) {
                        this.value = text;
                    }
                });
    
                input.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    showContextMenu(e, this);
                });
            });
            
            container.appendChild(itemDiv);
        }
        
        // Add a PO item card
        function addPoItem(data = {}) {
            const container = document.getElementById('po-items-container');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-card';
            
            itemDiv.innerHTML = `
                <div class="item-field">
                    <label>Description</label>
                    <input type="text" value="${data.description || ''}" class="item-description" readonly>
                </div>
                <div class="item-field">
                    <label>Quantity</label>
                    <input type="text" value="${data.quantity || ''}" class="item-quantity" readonly>
                </div>
                <div class="item-field">
                    <label>Unit Price</label>
                    <input type="text" value="${data.unitPrice || ''}" class="item-unit-price" readonly>
                </div>
                <div class="item-field">
                    <label>Total</label>
                    <input type="text" value="${data.total || ''}" class="item-total" readonly>
                </div>
                <button type="button" class="remove-item-btn"><i class="fas fa-times"></i></button>
            `;
            
            itemDiv.querySelector('.remove-item-btn').addEventListener('click', function() {
                itemDiv.remove();
            });
            
            itemDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.parentElement.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
                });
                
                input.addEventListener('dragleave', function() {
                    this.parentElement.style.backgroundColor = '';
                });
                
                input.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.parentElement.style.backgroundColor = '';
                    const text = e.dataTransfer.getData('text/plain');
                    if (text) {
                        this.value = text;
                    }
                });
    
                input.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    showContextMenu(e, this);
                });
            });
            
            container.appendChild(itemDiv);
        }
    
        // Add a custom field
        function addCustomField() {
            const fieldName = document.getElementById('field-name').value.trim();
            if (!fieldName) {
                showStatus('Field name is required', 'error', document.getElementById('field-status'));
                return;
            }
    
            const container = currentDocumentType === 'Invoice' ? 
                document.getElementById('custom-fields-container') : 
                document.getElementById('po-custom-fields-container');
                
            const fieldId = `custom-${fieldName.toLowerCase().replace(/\s+/g, '-')}`;
            
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'form-group';
            fieldDiv.innerHTML = `
                <label for="${fieldId}" class="form-label">${fieldName}</label>
                <div class="drop-area" id="${fieldId}-drop" data-field="${fieldId}">
                    <input type="text" id="${fieldId}" name="${fieldId}" class="form-control" 
                           placeholder="Enter value" autocomplete="off" readonly>
                    <span class="edit-hint">Right-click to edit</span>
                </div>
            `;
    
            const input = fieldDiv.querySelector('input');
            input.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                showContextMenu(e, this);
            });
    
            container.appendChild(fieldDiv);
            
            document.getElementById('field-name').value = '';
            document.getElementById('add-field-modal').style.display = 'none';
        }
        
        // Normalize date format for input[type=date]
        function normalizeDate(dateStr) {
            if (!dateStr) return '';
            
            const formats = [
                'DD/MM/YYYY', 'DD-MM-YYYY', 'DD.MM.YYYY',
                'MM/DD/YYYY', 'MM-DD-YYYY', 'MM.DD.YYYY',
                'YYYY/MM/DD', 'YYYY-MM-DD', 'YYYY.MM.DD',
                'DD MMM YYYY', 'DD MMMM YYYY', 'MMM DD, YYYY',
                'MMMM DD, YYYY', 'DD-MMM-YYYY', 'DD/MMM/YYYY'
            ];
            
            const date = moment(dateStr, formats, true);
            if (date.isValid()) {
                return date.format('YYYY-MM-DD');
            }
            
            const parts = dateStr.split(/[\/\-\s,]/).filter(part => part.trim() !== '');
            if (parts.length === 3) {
                let day, month, year;
                
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                    'July', 'August', 'September', 'October', 'November', 'December'];
                const shortMonthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                       'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                const monthIndex = monthNames.findIndex(m => dateStr.includes(m)) + 1 || 
                                  shortMonthNames.findIndex(m => dateStr.includes(m)) + 1;
                
                if (monthIndex > 0) {
                    const monthStr = monthIndex.toString().padStart(2, '0');
                    
                    if (dateStr.includes(',')) {
                        day = parts[1].padStart(2, '0');
                        year = parts[2];
                    } else {
                        day = parts[0].padStart(2, '0');
                        year = parts[2];
                    }
                    
                    return `${year}-${monthStr}-${day}`;
                } else {
                    const dayPart = parseInt(parts[0]);
                    const monthPart = parseInt(parts[1]);
                    
                    if (dayPart > 12) {
                        return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    } else if (monthPart > 12) {
                        return `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                    } else {
                        return `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                    }
                }
            }
            
            return dateStr;
        }
        
        // Display detected fields
        function displayDetectedFields(isPo = false) {
            const fieldsContent = isPo ? 
                document.getElementById('po-fields-content') : 
                document.getElementById('fields-content');
            fieldsContent.innerHTML = '';
            
            if (Object.keys(detectedFields).length === 0) {
                fieldsContent.innerHTML = '<p>No fields detected automatically. Please use drag and drop.</p>';
                return;
            }
            
            const fieldsList = document.createElement('ul');
            fieldsList.style.listStyleType = 'none';
            fieldsList.style.padding = '0';
            
            for (const [field, data] of Object.entries(detectedFields)) {
                const listItem = document.createElement('li');
                listItem.style.marginBottom = '10px';
                listItem.style.padding = '10px';
                listItem.style.backgroundColor = '#f0f0f0';
                listItem.style.borderRadius = '4px';
                
                const fieldName = document.createElement('strong');
                fieldName.textContent = field.replace('-', ' ') + ': ';
                fieldName.style.textTransform = 'capitalize';
                
                const fieldValue = document.createElement('span');
                fieldValue.textContent = data.value;
                
                const confidence = document.createElement('span');
                confidence.textContent = ` (${data.confidence} confidence)`;
                confidence.style.color = data.confidence === 'high' ? 'var(--success-color)' : 'var(--dark-gray)';
                confidence.style.fontSize = '0.8em';
                confidence.style.marginLeft = '5px';
                
                listItem.appendChild(fieldName);
                listItem.appendChild(fieldValue);
                listItem.appendChild(confidence);
                fieldsList.appendChild(listItem);
            }
            
            fieldsContent.appendChild(fieldsList);
        }
    
        // Update amount details based on total amount
        function updateAmountDetails() {
            const totalAmount = parseCurrency(document.getElementById('total-amount').value);
            
            if (isNaN(totalAmount)) {
                document.getElementById('subtotal-amount').textContent = '$0.00';
                document.getElementById('cgst-amount').textContent = '$0.00';
                document.getElementById('sgst-amount').textContent = '$0.00';
                document.getElementById('gst-amount').textContent = '$0.00';
                document.getElementById('grand-total-amount').textContent = '$0.00';
                return;
            }
    
            const subtotal = totalAmount / (1 + (gstRate/100));
            const gstAmount = totalAmount - subtotal;
            const cgstAmount = gstAmount / 2;
            const sgstAmount = gstAmount / 2;
    
            document.getElementById('subtotal-amount').textContent = formatCurrency(subtotal);
            document.getElementById('cgst-amount').textContent = formatCurrency(cgstAmount);
            document.getElementById('sgst-amount').textContent = formatCurrency(sgstAmount);
            document.getElementById('gst-amount').textContent = formatCurrency(gstAmount);
            document.getElementById('grand-total-amount').textContent = formatCurrency(totalAmount);
        }
        
        // Update PO amount details
        function updatePoAmountDetails() {
            const totalAmount = parseCurrency(document.getElementById('po-total-amount').value);
            
            if (isNaN(totalAmount)) {
                document.getElementById('po-subtotal-amount').textContent = '$0.00';
                document.getElementById('po-cgst-amount').textContent = '$0.00';
                document.getElementById('po-sgst-amount').textContent = '$0.00';
                document.getElementById('po-gst-amount').textContent = '$0.00';
                document.getElementById('po-grand-total-amount').textContent = '$0.00';
                return;
            }
    
            const subtotal = totalAmount / (1 + (gstRate/100));
            const gstAmount = totalAmount - subtotal;
            const cgstAmount = gstAmount / 2;
            const sgstAmount = gstAmount / 2;
    
            document.getElementById('po-subtotal-amount').textContent = formatCurrency(subtotal);
            document.getElementById('po-cgst-amount').textContent = formatCurrency(cgstAmount);
            document.getElementById('po-sgst-amount').textContent = formatCurrency(sgstAmount);
            document.getElementById('po-gst-amount').textContent = formatCurrency(gstAmount);
            document.getElementById('po-grand-total-amount').textContent = formatCurrency(totalAmount);
        }
        
        // Zoom functions
        function zoomIn(type) {
            if (type === 'viewer' || type === 'po-viewer') {
                if (scale < 3.0) {
                    scale += 0.25;
                    renderPage(currentPage, type);
                    updateZoomDisplay();
                }
            } else {
                if (selectScale < 3.0) {
                    selectScale += 0.25;
                    renderPage(selectPage, type);
                    updateZoomDisplay();
                }
            }
        }
        
        function zoomOut(type) {
            if (type === 'viewer' || type === 'po-viewer') {
                if (scale > 0.5) {
                    scale -= 0.25;
                    renderPage(currentPage, type);
                    updateZoomDisplay();
                }
            } else {
                if (selectScale > 0.5) {
                    selectScale -= 0.25;
                    renderPage(selectPage, type);
                    updateZoomDisplay();
                }
            }
        }
        
        function updateZoomDisplay() {
            zoomLevel.textContent = `${Math.round(scale * 100)}%`;
            selectZoomLevel.textContent = `${Math.round(selectScale * 100)}%`;
            document.getElementById('po-zoom-level').textContent = `${Math.round(scale * 100)}%`;
            document.getElementById('po-select-zoom-level').textContent = `${Math.round(selectScale * 100)}%`;
        }
        
        // Page navigation
        function goToPrevPage(type) {
            if (type === 'viewer' || type === 'po-viewer') {
                if (currentPage > 1) {
                    currentPage--;
                    renderPage(currentPage, type);
                    updatePageInfo(type);
                }
            } else {
                if (selectPage > 1) {
                    selectPage--;
                    renderPage(selectPage, type);
                    updatePageInfo(type);
                }
            }
        }
        
        function goToNextPage(type) {
            if (type === 'viewer' || type === 'po-viewer') {
                if (pdfDocument && currentPage < pdfDocument.numPages) {
                    currentPage++;
                    renderPage(currentPage, type);
                    updatePageInfo(type);
                }
            } else {
                if (pdfDocument && selectPage < pdfDocument.numPages) {
                    selectPage++;
                    renderPage(selectPage, type);
                    updatePageInfo(type);
                }
            }
        }
        
        // Update page info display
        function updatePageInfo(type) {
            if (pdfDocument) {
                if (type === 'viewer') {
                    document.getElementById('page-info').textContent = 
                        `Page ${currentPage} of ${pdfDocument.numPages}`;
                } else if (type === 'select') {
                    document.getElementById('select-page-info').textContent = 
                        `Page ${selectPage} of ${pdfDocument.numPages}`;
                } else if (type === 'po-viewer') {
                    document.getElementById('po-page-info').textContent = 
                        `Page ${currentPage} of ${pdfDocument.numPages}`;
                } else if (type === 'po-select') {
                    document.getElementById('po-select-page-info').textContent = 
                        `Page ${selectPage} of ${pdfDocument.numPages}`;
                }
            }
        }

        // Save document (invoice or PO) to database
        function saveDocument() {
            const isInvoice = currentDocumentType === 'Invoice';
            const form = isInvoice ? document.getElementById('invoice-form') : document.getElementById('po-form');
            const formStatusElement = isInvoice ? formStatus : document.getElementById('po-form-status');
            const approvalType = document.querySelector(`input[name="${isInvoice ? 'approval-type' : 'po-approval-type'}"]:checked`).value;
            
            // Validate required fields
            if (isInvoice && !document.getElementById('invoice-number').value) {
                showStatus('Invoice Number is required', 'error', formStatusElement);
                return;
            }
            
            if (!document.getElementById(isInvoice ? 'total-amount' : 'po-total-amount').value) {
                showStatus('Total Amount is required', 'error', formStatusElement);
                return;
            }
            
            if (isInvoice && fileAttachments.files.length === 0) {
                showStatus('At least one attachment is required for invoices', 'error', formStatusElement);
                return;
            }

            // Prepare form data
            const formData = {
                documentType: currentDocumentType,
                invoiceNumber: isInvoice ? document.getElementById('invoice-number').value : null,
                poNumber: isInvoice ? document.getElementById('po-number').value : document.getElementById('po-po-number').value,
                invoiceDate: isInvoice ? document.getElementById('invoice-date').value : document.getElementById('po-po-date').value,
                paymentTerms: isInvoice ? document.getElementById('payment-terms').value : document.getElementById('po-payment-terms').value,
                totalAmount: isInvoice ? document.getElementById('total-amount').value : document.getElementById('po-total-amount').value,
                vendorInfo: isInvoice ? document.getElementById('vendor-info').value : document.getElementById('po-vendor-info').value,
                items: [],
                customFields: {},
                approvalType: approvalType, // Use the selected approval type
                gstRate: gstRate
            };

            // Add items
            document.querySelectorAll(isInvoice ? '.item-card' : '#po-items-container .item-card').forEach(item => {
                formData.items.push({
                    description: item.querySelector('.item-description').value,
                    quantity: item.querySelector('.item-quantity').value,
                    unitPrice: item.querySelector('.item-unit-price').value,
                    total: item.querySelector('.item-total').value
                });
            });
    
            // Add custom fields
            document.querySelectorAll(isInvoice ? '#custom-fields-container .form-group' : '#po-custom-fields-container .form-group').forEach(field => {
                const label = field.querySelector('label');
                const input = field.querySelector('input');
                if (label && input) {
                    formData.customFields[label.textContent] = input.value;
                }
            });
    
            // Calculate amounts
            const totalAmountNum = parseCurrency(formData.totalAmount);
            const gstAmount = totalAmountNum * (gstRate / 100);
            const subtotal = totalAmountNum - gstAmount;
            
            formData.subtotal = formatCurrency(subtotal);
            formData.cgstAmount = formatCurrency(gstAmount / 2);
            formData.sgstAmount = formatCurrency(gstAmount / 2);
            formData.gstAmount = formatCurrency(gstAmount);
            
            // Handle file uploads
            if (isInvoice) {
                if (pdfUpload.files.length > 0) {
                    const fileReader = new FileReader();
                    fileReader.onload = function() {
                        const arrayBuffer = this.result;
                        const uint8Array = new Uint8Array(arrayBuffer);
                        const base64String = btoa(String.fromCharCode.apply(null, uint8Array));
                        formData.documentData = base64String;
                        
                        // Handle attachments
                        if (fileAttachments.files.length > 0) {
                            const attachments = [];
                            const fileReaders = Array.from(fileAttachments.files).map(file => {
                                return new Promise((resolve) => {
                                    const reader = new FileReader();
                                    reader.onload = function() {
                                        const arrayBuffer = this.result;
                                        const uint8Array = new Uint8Array(arrayBuffer);
                                        const base64String = btoa(String.fromCharCode.apply(null, uint8Array));
                                        attachments.push({
                                            name: file.name,
                                            type: file.type,
                                            data: base64String
                                        });
                                        resolve();
                                    };
                                    reader.readAsArrayBuffer(file);
                                });
                            });
                            
                            Promise.all(fileReaders).then(() => {
                                formData.attachments = attachments;
                                sendDocumentData(formData, formStatusElement);
                            });
                        } else {
                            sendDocumentData(formData, formStatusElement);
                        }
                    };
                    fileReader.readAsArrayBuffer(pdfUpload.files[0]);
                } else {
                    sendDocumentData(formData, formStatusElement);
                }
            } else {
                // For POs
                if (poPdfUpload.files.length > 0) {
                    const fileReader = new FileReader();
                    fileReader.onload = function() {
                        const arrayBuffer = this.result;
                        const uint8Array = new Uint8Array(arrayBuffer);
                        const base64String = btoa(String.fromCharCode.apply(null, uint8Array));
                        formData.documentData = base64String;
                        sendDocumentData(formData, formStatusElement);
                    };
                    fileReader.readAsArrayBuffer(poPdfUpload.files[0]);
                } else {
                    sendDocumentData(formData, formStatusElement);
                }
            }
        }
    
        // Send document data to server
        function sendDocumentData(formData, statusElement) {
            showLoading(true);
            const saveBtn = formData.documentType === 'Invoice' ? 
                document.getElementById('save-btn') : 
                document.getElementById('po-save-btn');
            saveBtn.disabled = true;
            
            fetch('/api/invoices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showStatus(`${formData.documentType} saved successfully and sent for approval!`, 'success', statusElement);
                    resetForm();
                    if (invoicesTable) {
                        invoicesTable.ajax.reload();
                    }
                    showSection('#invoices-section');
                } else {
                    throw new Error(data.error || `Failed to save ${formData.documentType}`);
                }
            })
            .catch(error => {
                console.error(`Error saving ${formData.documentType}:`, error);
                showStatus(`Error saving ${formData.documentType}: ` + error.message, 'error', statusElement);
            })
            .finally(() => {
                showLoading(false);
                saveBtn.disabled = false;
            });
        }
        
        // Reset form
        function resetForm() {
            if (currentDocumentType === 'Invoice') {
                document.getElementById('invoice-form').reset();
                document.getElementById('invoice-items-container').innerHTML = '';
                document.getElementById('custom-fields-container').innerHTML = '';
                document.getElementById('current-filename').textContent = 'None';
                documentInfo.style.display = 'none';
                
                document.getElementById('subtotal-amount').textContent = '$0.00';
                document.getElementById('cgst-amount').textContent = '$0.00';
                document.getElementById('sgst-amount').textContent = '$0.00';
                document.getElementById('gst-amount').textContent = '$0.00';
                document.getElementById('grand-total-amount').textContent = '$0.00';
                
                document.getElementById('file-attachments').value = '';
                document.getElementById('attachments-list').innerHTML = '';
            } else {
                document.getElementById('po-form').reset();
                document.getElementById('po-items-container').innerHTML = '';
                document.getElementById('po-custom-fields-container').innerHTML = '';
                document.getElementById('po-current-filename').textContent = 'None';
                poDocumentInfo.style.display = 'none';
                
                document.getElementById('po-subtotal-amount').textContent = '$0.00';
                document.getElementById('po-cgst-amount').textContent = '$0.00';
                document.getElementById('po-sgst-amount').textContent = '$0.00';
                document.getElementById('po-gst-amount').textContent = '$0.00';
                document.getElementById('po-grand-total-amount').textContent = '$0.00';
            }
            
            if (pdfDocument) {
                if (currentDocumentType === 'Invoice') {
                    document.getElementById('pdf-viewer').innerHTML = '';
                    document.getElementById('pdf-select-viewer').innerHTML = '';
                } else {
                    document.getElementById('po-pdf-viewer').innerHTML = '';
                    document.getElementById('po-pdf-select-viewer').innerHTML = '';
                }
                pdfDocument = null;
            }
            
            if (currentDocumentType === 'Invoice') {
                document.getElementById('page-info').textContent = 'Page 1 of 1';
                document.getElementById('select-page-info').textContent = 'Page 1 of 1';
                
                document.getElementById('fields-content').innerHTML = '';
                document.getElementById('extracted-text-content').innerHTML = '';
            } else {
                document.getElementById('po-page-info').textContent = 'Page 1 of 1';
                document.getElementById('po-select-page-info').textContent = 'Page 1 of 1';
                
                document.getElementById('po-fields-content').innerHTML = '';
                document.getElementById('po-extracted-text-content').innerHTML = '';
            }
        }
        
        // Show status message
        function showStatus(message, type, element) {
            element.textContent = message;
            element.className = 'status-message ' + type;
            
            if (type === 'success') {
                setTimeout(() => {
                    element.textContent = '';
                    element.className = 'status-message';
                }, 5000);
            }
        }
        
        // Show/hide loading spinner
        function showLoading(show) {
            const spinner = document.getElementById('loading-spinner');
            spinner.style.display = show ? 'flex' : 'none';
        }

        // Format currency while preserving the original format
        function formatCurrency(value) {
            if (typeof value === 'string') {
                if (/[a-zA-Z$]/.test(value)) {
                    return value;
                }
                
                value = parseFloat(value.replace(/[^0-9.-]/g, ''));
                if (isNaN(value)) return '$0.00';
            }
            
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(value);
        }

        // Parse currency string to number
        function parseCurrency(value) {
            if (!value) return 0;
            if (typeof value === 'number') return value;
            
            const numericValue = parseFloat(value.replace(/[^0-9.-]/g, ''));
            return isNaN(numericValue) ? 0 : numericValue;
        }

        // Close modal
        function closeModal() {
            this.closest('.modal').style.display = 'none';
        }
        document.addEventListener('DOMContentLoaded', function() {
        const authToken = sessionStorage.getItem('authToken');
        const userData = JSON.parse(sessionStorage.getItem('userData'));
        
        if (!authToken || !userData) {
            window.location.href = 'login.html';
        }
        
        // Update UI with user info
        if (userData) {
            const usernameElement = document.querySelector('.username');
            const roleElement = document.querySelector('.role');
            
            if (usernameElement) {
                usernameElement.textContent = userData.name || userData.email;
            }
            
            if (roleElement) {
                roleElement.textContent = userData.department === 'Admin' ? 'Administrator' : 
                                         userData.department === 'AP' ? 'AP Team' : 
                                         userData.department === 'CFO' ? 'CFO' : 
                                         userData.department === 'Manager' ? 'Manager' : 'User';
            }
        }
    });
    
    // Logout function
    function logout() {
        sessionStorage.removeItem('authToken');
        sessionStorage.removeItem('userData');
        window.location.href = 'login.html';
    }
    </script>
</body>
</html>